<!DOCTYPE html>
<html lang="en">
<head th:replace="fragments/head :: head(${title})"></head>
<body>

<nav th:replace="fragments/left_navbar_button:: left_navbar_button"></nav>
<nav th:replace="fragments/left_navbar:: left_navbar"></nav>

<main class="content">
  <nav th:replace="fragments/top_navbar:: top_navbar(${title})"></nav>

  <div class="row d-flex justify-content-center my-6">
    <div class="col-12 col-md-10 col-xl-8">
      <div th:replace="fragments/message:: message"></div>

      <form action="" method="post" id="mainForm" th:object="${entity}">
        <div class="card card-body border-0 shadow mb-4" th:each="group: ${form.groups}">
          <h2 class="h5 mb-4" th:text="${group.key}"></h2>
          <div class="row" th:each="column: ${group.value}"
               th:classappend="${column.formType} == ${T(org.termi.common.enumeration.FormType).HIDDEN} ? 'd-none'">

            <div th:class="'mb-3 col-md-' + ${column.grid}" th:switch="${column.formType}">
              <div
                  th:classappend="${column.formType} == ${T(org.termi.common.enumeration.FormType).SWITCH} ? 'form-check form-switch'">

                <label th:for="${column.columnName}"
                       th:utext="${column.label}"
                       th:unless="${column.formType} == ${T(org.termi.common.enumeration.FormType).HIDDEN}"></label>

                <input th:case="${T(org.termi.common.enumeration.FormType).SWITCH}"
                       class="form-check-input"
                       type="checkbox"
                       th:disabled="${column.disabled}"
                       th:required="${column.required}"
                       th:field="*{__${column.columnName}__}"/>

                <input th:case="${T(org.termi.common.enumeration.FormType).HIDDEN}"
                       class="form-control"
                       type="hidden"
                       th:disabled="${column.disabled}"
                       th:required="${column.required}"
                       th:field="*{__${column.columnName}__}"/>

                <input th:case="${T(org.termi.common.enumeration.FormType).TEXT}"
                       class="form-control"
                       type="text"
                       th:disabled="${column.disabled}"
                       th:required="${column.required}"
                       th:field="*{__${column.columnName}__}"/>

                <input th:case="${T(org.termi.common.enumeration.FormType).NUMBER}"
                       class="form-control"
                       type="number"
                       th:disabled="${column.disabled}"
                       th:required="${column.required}"
                       th:field="*{__${column.columnName}__}"/>

                <textarea th:case="${T(org.termi.common.enumeration.FormType).TEXTAREA}"
                          class="form-control"
                          th:disabled="${column.disabled}"
                          th:required="${column.required}"
                          th:field="*{__${column.columnName}__}"></textarea>

                <div th:case="${T(org.termi.common.enumeration.FormType).EDITOR}">
                  <input type="hidden"
                         class="form-control"
                         th:disabled="${column.disabled}"
                         th:required="${column.required}"
                         th:field="*{__${column.columnName}__}"/>
                  <div id="editor" th:data-input-id="${column.columnName}"></div>
                </div>

                <div th:case="${T(org.termi.common.enumeration.FormType).SELECT}" class="input-group">
                  <select class="form-select"
                          th:data-url="@{${column.extra.url}(id=*{id})}"
                          th:data-searchable="${column.extra.searchable}"
                          th:data-value="${column.value}"
                          th:multiple="${column.extra.multiple}"
                          th:disabled="${column.disabled}"
                          th:required="${column.required}"
                          th:field="*{__${column.columnName}__}">
                  </select>
                  <button type="button"
                          class="btn btn-gray-300"
                          th:data-select-id="${column.columnName}"
                          onclick="refreshSelect(this);">
                    <i class="bi bi-arrow-clockwise"></i>
                  </button>
                </div>

                <div th:case="${T(org.termi.common.enumeration.FormType).IMAGES}"
                     th:data-name="${column.columnName}"
                     class="dropzone rounded">
                  <div class="dz-default dz-message">
                    <p>Drop files here to upload</p>
                    <p class="text-muted small">(Max file size is 20MB and max number of files is 5)</p>
                  </div>
                  <input type="hidden"
                         th:name="${column.columnName}"
                         th:each="uri: ${#strings.arraySplit(column.value, ',')}"
                         th:id="${uri}"
                         th:value="${uri}">
                </div>

                <div th:case="${T(org.termi.common.enumeration.FormType).IMAGE}">
                  <img th:src="${UPLOAD_BASE_URL} + ${column.value}" class="img-fluid"/>
                </div>

                <div th:if="${#fields.hasErrors(column.columnName)}" class="my-2">
                  <div th:each="err : ${#fields.errors(column.columnName)}"
                       th:text="${err}"
                       class="invalid-feedback" role="alert"></div>
                </div>

              </div>
            </div>
          </div>

        </div>

        <div class="mt-2 mb-4">
          <button type="submit" class="btn btn-secondary">
            Save
          </button>
          <a class="btn btn-gray-300" th:unless="${parentId}" th:href="${BASE_URL}">
            Back
          </a>

          <a class="btn btn-gray-300" th:if="${parentId}" th:href="@{${BASE_URL}(parentId=${parentId})}">
            Back
          </a>
        </div>
      </form>
    </div>

  </div>

</main>


<!--/*/ <th:block th:replace="fragments/scripts :: scripts"> /*/-->
<!--/*/ </th:block> /*/-->

<!-- Quill library -->
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

<!-- dropzone -->
<script src="https://cdn.jsdelivr.net/npm/dropzone@5.9.3/dist/dropzone.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/choices.js@10.2.0/public/assets/scripts/choices.min.js"></script>


<script th:inline="javascript" th:if="${UPLOAD_BASE_URL} ne null">
    /*<![CDATA[*/
    var uploadBaseUrl = /*[[${UPLOAD_BASE_URL}]]*/ '';
    /*]]>*/
</script>

<script type="application/javascript">
    Dropzone.autoDiscover = false;
    const mainForm = document.getElementById("mainForm");
    let selectObjects = {}

    /* Editor */
    const initEditor = function () {
        var editorEl = document.getElementById("editor")
        if (editorEl === null) {
            return;
        }
        const inputEl = document.getElementById(editorEl.getAttribute("data-input-id"));
        var toolbarOptions = [
            ['bold', 'italic', 'underline', 'strike'],        // toggled buttons
            ['blockquote', 'code-block'],

            [{'header': 1}, {'header': 2}],               // custom button values
            [{'list': 'ordered'}, {'list': 'bullet'}],
            [{'script': 'sub'}, {'script': 'super'}],      // superscript/subscript
            [{'indent': '-1'}, {'indent': '+1'}],          // outdent/indent
            [{'direction': 'rtl'}],                         // label direction

            [{'size': ['small', false, 'large', 'huge']}],  // custom dropdown
            [{'header': [1, 2, 3, 4, 5, 6, false]}],

            [{'color': []}, {'background': []}],          // dropdown with defaults from theme
            [{'font': []}],
            [{'align': []}],

            ['link', 'image'],

            ['clean']                                         // remove formatting button
        ];

        var quill = new Quill('#editor', {
            modules: {
                toolbar: toolbarOptions
            },
            theme: 'snow'
        });
        const delta = quill.clipboard.convert(inputEl.value)
        quill.setContents(delta, 'silent')

        quill.on('text-change', function () {
            inputEl.value = quill.root.innerHTML;
        })
    }

    /* Select */
    const refreshSelect = function (btn) {
        const selectId = btn.getAttribute('data-select-id');
        const selectEl = document.getElementById(selectId);
        const dataUrl = selectEl.getAttribute("data-url");
        const initValue = selectEl.getAttribute("data-value");
        loadSelectOptions(selectId, dataUrl, initValue);
    }

    const initSelect = function () {
        let selectElements = document.getElementsByClassName("form-select");
        Array.from(selectElements).forEach(function (selectEl) {
            const dataUrl = selectEl.getAttribute("data-url");
            const searchable = selectEl.getAttribute("data-searchable") === 'true';
            const initValue = selectEl.getAttribute("data-value");

            const selectObject = new Choices(selectEl, {
                searchEnabled: selectEl.multiple || searchable,
                searchChoices: selectEl.multiple || searchable,
                shouldSort: false,
                allowHTML: true,
                removeItemButton: !selectEl.required,
                classNames: {
                    containerOuter: 'choices mb-0 w-75',
                    containerInner: 'choices__inner rounded-start'
                }
            });

            const selectId = selectEl.id;
            selectObjects[selectId] = selectObject;
            loadSelectOptions(selectId, dataUrl, initValue);
        });
    }

    const loadSelectOptions = async (selectId, dataUrl, initValue) => {
        const selectObject = selectObjects[selectId];
        const data = await fetch(dataUrl)
            .then(function (response) {
                return response.json();
            })
            .then(function (options) {
                return options.map(function (option) {
                    return {
                        label: option.label,
                        value: option.value,
                        selected: (option.value === initValue)
                    };
                });
            });

        selectObject.clearStore();
        selectObject.setChoices(data, "value", "label", true);
    }

    const loadExistingPictures = function (dropzone) {
        document.getElementsByClassName("dropzone").forEach(function (selectEl) {
            const name = selectEl.getAttribute("data-name");

            document.getElementsByName(name).forEach((input) => {
                const uri = input.value;
                var imageUrl = uploadBaseUrl + uri;
                var mockFile = {
                    id: uri,
                    name: uri,
                    status: Dropzone.ADDED,
                };

                let callback = null; // Optional callback when it's done
                let crossOrigin = "Anonymous"; // Added to the `img` tag for crossOrigin handling
                let resizeThumbnail = true; // Tells Dropzone whether it should resize the image first

                dropzone.displayExistingFile(mockFile, imageUrl, callback, crossOrigin, resizeThumbnail);
                dropzone.files.push(mockFile);
            });

        });
    }

    const initDropzone = function () {
        if (document.getElementsByClassName("dropzone").length === 0) {
            return;
        }

        return new Dropzone("div.dropzone", {
            url: "/admin/api/upload",
            dictCancelUpload: "Cancel",
            dictRemoveFile: "Remove",
            addRemoveLinks: true,
            maxFiles: 5,
            success: function (file, response) {
                var name = this.element.getAttribute("data-name");
                file.id = response.uri;
                createHiddenInput(name, response.uri);
                file.previewElement.classList.add("dz-success");
            },

            error: function (file, response) {
                file.previewElement.classList.add("dz-error");
            },

            removedfile: function (file) {
                removeHiddenInput(file.id);
                file.previewElement.remove();
            },

            init: function () {
                loadExistingPictures(this);
            }
        });
    }

    const initSlug = function () {
        var slugElements = document.getElementsByName("slug");
        var nameElements = document.getElementsByName("name");

        if (slugElements.length !== 1 || nameElements.length !== 1) {
            return;
        }

        var slugEl = slugElements[0];
        var slugHasInitialValue = (slugEl.value.trim().length !== 0);
        nameElements[0].addEventListener("input", function () {
            if (slugHasInitialValue) {
                // do not change slug if it has had value
                return;
            }

            slugEl.value = this.value
                .replace(/\W+/ig, "-")
                .replace(/-{2,}/, "-")
                .trimSlash()
                .toLowerCase();
        })
    }

    window.onload = function () {
        initSelect();
        initEditor();
        initDropzone();
        initSlug();
    }

</script>

</body>
</html>